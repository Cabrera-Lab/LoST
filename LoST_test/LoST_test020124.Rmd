---
title: "LoST_test for bias correction"
output: html_notebook
---

# Setup
```{r}
install.packages("LoST_1.0.0.tar.gz", repos = NULL, type = "source")
library(LoST)
library(dplyr) 
library(tidyr)
library(ggplot2)
library(fields)
```

# Modeling for empirical bias correction function

## Step 1: Generate simulated phage images by LoST for modeling the empirical bias correction method (See image_model.R)

## Step 2: Obtain observed count and estimated spot size by LoST for each image and save results of images for modeling (See image_model.R & result_model.csv)

## Step 3: Read simulated results and fit the empirical bias correction function
```{r}
## read the training data frame
res_model = read.csv("result_model.csv")[,2:5]
res_model = na.omit(res_model)

## fit thin plate spline
fit <- Tps(x = data.frame(res_model$obs_count,res_model$obs_size),Y = res_model$true_count)
```


#Modeling for theoretical bias correction function
```{r}
circdprob = function(d,r){
  2*asin(d/(2*r))/pi+2*d^2*acos(d/(2*r))/(pi*r^2)-(d*(2*r^2+d^2)*sqrt(4-d^2/r^2))/(4*pi*r^3)
}

est_N <- function(x1,spot_dia,well_dia=400){
  c = (30*spot_dia+2*well_dia-500)/100
  p = circdprob(d = c,well_dia/2)
  uniroot(\(N,p,x) N-N*(N-1)/2*p+N*(N-1)*(N-2)/6*p^2-x, c(0, x1*1.5), p = p, x = x1,extendInt = "yes")$root
}
```


# Test bias correction performance

## Generate 10 simulated phage images for model testing: random size and random count
```{r}
#get the current filepath
mainDir = getwd()
#create a subfolder to save simulated images for model test
dir.create(file.path(mainDir, "test_images_random/"))
```

```{r}
#simulate phage images and save for model test

dir.create(paste(mainDir,"/test_images_random/test_images",sep = ""))
#number of test images with random size and random count
num = 10

for (i in 1:num) {
  print(paste("Generating random images index",i))
  
  #random count and random size sampled from uniform distribution
  ct_random = round(runif(1,min = 10,max = 150))
  sz_random = round(runif(1,min = 15,max = 40))
  print(paste("image with spot diameter",sz_random, "and with spot count",ct_random))
     
  #generate image
  img0 <- PhageImage_gen(s0 = ct_random, d2o = sz_random,seed0 = k) 
  writeImage(img0,paste(mainDir,"/test_images_random/test_images/test_ct",ct_random,"_sz",sz_random,".jpg",sep = ""))
}
```

## Obtain observed count and estimated spot size by LoST for each image and save results of images for testing
```{r}
# get a fake meta file about dilution information for LoST function
info = fread(system.file("extdata", "metafile_example.csv",package="LoST"))
names = list.files(paste(mainDir,"/test_images_random/test_images",sep = ""))
info <- do.call("rbind", replicate(length(names), info[1,], simplify = FALSE)) 
info$image_name = names
write.csv(info,paste(mainDir,"/test_images_random/info_test_random.csv",sep = ""))

# use LoST function to obtain count and estimated spot size
res0_model = LoST(paste(mainDir,"/test_images_random/test_images",sep = ""),meta.file = paste(mainDir,"/test_images_random/info_test_random.csv",sep = ""),use_dilute = F, dilute.model = F)
obs_count = as.numeric(res0_model@count)
obs_size = unlist(lapply(res0_model@clus_size, function(t){median(sqrt(unlist(t)/pi)*2)}))
true_count = as.numeric(gsub('[^[:alnum:] ]', '', substr(names,start = 8,stop = 10)))
true_size = as.numeric(gsub('[^[:digit:] ]', '', substr(names,start = 13,stop = 15)))

res_test = cbind(obs_count,obs_size,true_count,true_size)
colnames(res_test) = c("obs_count","obs_size","true_count","true_size")

#save the results for test
write.csv(res_test,paste(mainDir,"/test_images_random/result_test_random.csv",sep = ""))
```



## Conduct bias correction based on two methods
```{r,echo=FALSE}
  #read test image count results by LoST
  res_test = read.csv(paste(mainDir,"/test_images_random/result_test_random.csv",sep = ""))[,-1]
  res_test = na.omit(res_test)
  #original bias before correction
  res_test$ori_bias = res_test$obs_count - res_test$true_count
  
  #corrected count and bias by empirical method
  res_test$empirical_correct_count <- round(predict(fit, x = data.frame(res_test$obs_count,res_test$obs_size))[,1])
  res_test$empirical_bias = res_test$empirical_correct_count - res_test$true_count

  #corrected count and bias by theoretical method
  res_test$theo_correct_count = apply(cbind(res_test$obs_count,res_test$obs_size),1,function(t){est_N(t[1],t[2],well_dia = 395)})
  res_test$theo_correct_count = round(res_test$theo_correct_count)
  res_test$theo_bias = res_test$theo_correct_count - res_test$true_count
  res_test = res_test[order(res_test$true_count),]
```


## Plot bias correction results
```{r}  
  #line plot for bias 
ggplot(res_test, aes(x = true_count)) +
  geom_point(aes(y = theo_bias, color = "bias after theoretical correction")) +
  geom_point(aes(y = ori_bias, color = "bias before correction")) +
  geom_point(aes(y = empirical_bias, color = "bias after empirical correction")) +
  scale_x_reverse() +
  scale_y_continuous(limits = c(min(res_test$ori_bias, res_test$theo_bias, res_test$empirical_bias),
                                 max(res_test$ori_bias, res_test$theo_bias, res_test$empirical_bias))) +
  labs(x = "number of spot (true count)", y = "bias",color = "",title = "Random spot size and count number") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  scale_color_manual(values = c("bias before correction" = "black", "bias after theoretical correction" = "blue", "bias after empirical correction" = "red"))
  

  #box plot for bias
  df_long <- res_test[,c("ori_bias","theo_bias","empirical_bias")] %>% 
  gather(bias_type, bias_val, c("ori_bias","theo_bias","empirical_bias"))
  df_long$bias_type = factor(df_long$bias_type)
  df_long$bias_type = relevel(df_long$bias_type,ref = "ori_bias")

  p <- ggplot(data=df_long) + 
  geom_hline(yintercept = 0,lty=2)+
  geom_boxplot( aes(x=bias_type, y=bias_val), position=position_dodge(1)) +
  scale_x_discrete(breaks=c("ori_bias","theo_bias","empirical_bias"), labels=c("bias before\n correction", "bias after theoretical \ncorrection","bias after empirical \ncorrection")) +
  theme_minimal() +
  # scale_y_continuous(limits = c(-6,6)) +
  ggtitle("random spot diameter and count")
  print(p)
```
